# DUDULURUN Scanner API Documentation

This document provides comprehensive API documentation for the DUDULURUN scanner endpoints used by mobile applications for ticket validation and race check-in processes.

## Base URL

```
https://your-domain.com/api/scanner
```

## Authentication

All scanner endpoints require authentication using a secret code system. The mobile app must first authenticate before accessing other endpoints.

---

## Endpoints

### 1. Authentication

#### POST `/api/scanner/auth`

Authenticates the scanner application using a secret code.

**Request Body:**

```json
{
  "secretCode": "string"
}
```

**Response:**

```json
{
  "success": true
}
```

**Error Responses:**

- `400` - Secret code is required
- `401` - Invalid secret code
- `500` - Internal server error

---

### 2. Check Ticket Status

#### POST `/api/scanner/check`

Checks the current status of a ticket to determine what validation step is needed.

**Request Body:**

```json
{
  "ticketId": "string"
}
```

**Response:**

```json
{
  "data": {
    "checkedType": "racePack" | "checkIn",
    "registration": {
      "id": "number",
      "name": "string",
      "email": "string",
      "phone": "string",
      "category": "string",
      "packageType": "string",
      "shirtSize": "string",
      "customShirtSize": "string",
      "customChildShirtSize": "string",
      "childAge": "number",
      "familyPackageData": "object",
      "createdAt": "string",
      "updatedAt": "string"
    },
    "race": "object" | null
  }
}
```

**Response Types:**

- `checkedType: "racePack"` - Ticket needs race pack validation (first time)
- `checkedType: "checkIn"` - Ticket needs check-in validation (already validated for race pack)

**Error Responses:**

- `400` - Registration ID is required
- `404` - Registration not found
- `500` - Internal server error

#### QR Code Scanning Algorithm

The `/api/scanner/check` endpoint is designed to work with QR codes generated by the DUDULURUN system. Here's how the QR code scanning algorithm works:

**QR Code Generation Process:**

1. **Data Structure**: QR codes contain JSON data with the following structure:

   ```json
   {
     "id": "number",
     "name": "string", 
     "category": "string",
     "packageType": "string",
     "familyPackageData": "object",
     "racePackPhotoUrl": "string",
     "ticketUsed": "boolean"
   }
   ```

2. **Encryption**: The registration ID in the URL is encrypted using AES-256-CBC encryption before being embedded in the QR code URL.

3. **QR Code Library**: Uses the `qrcode` npm library to generate QR codes as data URLs.

**QR Code Scanning Process:**

1. **Scanner Library**: Uses `html5-qrcode` library for QR code detection and decoding.

2. **Scanner Configuration**:

   ```javascript
   {
     qrbox: {
       width: Math.min(window.innerWidth - 48, 250),
       height: Math.min(window.innerWidth - 48, 250)
     },
     fps: 10,
     aspectRatio: 1,
     showTorchButtonIfSupported: true,
     rememberLastUsedCamera: true
   }
   ```

3. **Decoding Process**:
   - Scanner captures QR code using device camera
   - Decodes QR code to extract JSON string
   - Validates JSON format (throws error if invalid)
   - Extracts `ticketId` from the decoded JSON data
   - Sends `ticketId` to `/api/scanner/check` endpoint

4. **Data Validation**:
   - Checks if `ticketId` exists in database
   - Verifies registration exists and is valid
   - Determines validation type based on race record existence

**QR Code Format Requirements:**

- **Format**: Standard QR Code (ISO/IEC 18004)
- **Encoding**: UTF-8 JSON string
- **Size**: Minimum 250x250 pixels recommended
- **Error Correction**: Medium level (15% error correction)
- **Data Limit**: Up to 2,953 bytes (sufficient for ticket data)

**Scanner Implementation Details:**

- **Camera Access**: Requires user permission for camera access
- **Multi-format Support**: Supports various QR code formats and orientations
- **Real-time Processing**: 10 FPS scanning rate for responsive detection
- **Error Handling**: Graceful handling of invalid QR codes and network errors
- **Auto-focus**: Automatic focus adjustment for better scanning accuracy

**Security Features:**

- **Encrypted URLs**: Registration IDs are encrypted in QR code URLs
- **JSON Validation**: Strict JSON format validation before processing
- **Database Verification**: All ticket data is verified against database records
- **Authentication Required**: Scanner must be authenticated before use

---

### 3. Validate Ticket

#### POST `/api/scanner/validate`

Validates a ticket for race pack collection or check-in process.

**Request Body:**

```json
{
  "id": "string",
  "ktpChecked": "boolean",
  "bibChecked": "boolean",
  "jerseyChecked": "boolean",
  "racePackPhoto": "string" // Base64 encoded image (data:image/...)
}
```

**Validation Rules:**

- For **first-time validation** (race pack collection):
  - `bibChecked` must be `true`
  - `jerseyChecked` must be `true`
  - `racePackPhoto` must be a valid base64 image string
  - `ktpChecked` is not required

- For **check-in validation** (already collected race pack):
  - `ktpChecked` must be `true`
  - Other fields are not required

**Response (Success):**

```json
{
  "success": true,
  "message": "Ticket validated successfully",
  "data": {
    "name": "string",
    "category": "string",
    "packageDetails": {
      "type": "string",
      "shirtSize": "string",
      "familyDetails": "object" | null,
      "racePackPhotoUrl": "string"
    },
    "ticketUsed": true
  }
}
```

**Response (Already Used):**

```json
{
  "success": false,
  "message": "This ticket has already been used",
  "data": {
    "name": "string",
    "category": "string",
    "packageDetails": {
      "type": "string",
      "shirtSize": "string",
      "familyDetails": "object" | null,
      "racePackPhotoUrl": "string"
    },
    "ticketUsed": true
  }
}
```

**Error Responses:**

- `400` - Invalid ticket data / Ticket payment not completed / KTP not checked / Bib not checked / Jersey not checked / Race pack photo is required / Invalid race pack photo format / No available id for this category
- `404` - Ticket not found
- `500` - Internal server error

---

## Data Models

### Registration

```typescript
interface Registration {
  id: number;
  name: string;
  email: string;
  phone: string;
  category: "fun" | "family";
  packageType: string;
  shirtSize?: string;
  customShirtSize?: string;
  customChildShirtSize?: string;
  childAge?: number;
  familyPackageData?: object;
  createdAt: string;
  updatedAt: string;
}
```

### Package Details

```typescript
interface PackageDetails {
  type: string;
  shirtSize: string;
  familyDetails: object | null;
  racePackPhotoUrl: string;
}
```

### Family Package Data

```typescript
interface FamilyPackageData {
  // Structure depends on the family package configuration
  // This is stored as JSON in the database
}
```

---

## Race ID Assignment Logic

The system automatically assigns race IDs based on category:

- **Fun Run**: IDs 1-300 and 377-428
- **Family Run**: IDs 377-428

The system finds the last assigned ID for each category and assigns the next available ID.

---

## Image Handling

### Race Pack Photo

- Must be provided as base64 encoded string
- Format: `data:image/{extension};base64,{base64Data}`
- Supported formats: jpg, jpeg, png, gif, webp
- Images are stored in `/public/race-packs/` directory
- Public URL format: `{BASE_URL}/race-packs/{filename}`

---

## Error Handling

All endpoints return consistent error responses:

```json
{
  "error": "Error message description"
}
```

Common HTTP status codes:

- `200` - Success
- `400` - Bad Request (validation errors)
- `401` - Unauthorized (authentication failed)
- `404` - Not Found
- `500` - Internal Server Error

---

## Usage Flow

### 1. Authentication Flow

```
1. POST /api/scanner/auth
   - Send secret code
   - Receive success confirmation
```

### 2. Ticket Validation Flow

```
1. POST /api/scanner/check
   - Send ticket ID
   - Receive ticket status and data

2. POST /api/scanner/validate
   - Send validation data based on checkedType
   - Receive validation result
```

### 3. Complete Validation Process

```
1. Authenticate scanner
2. Check ticket status
3. If checkedType = "racePack":
   - Validate with bibChecked, jerseyChecked, racePackPhoto
4. If checkedType = "checkIn":
   - Validate with ktpChecked
5. Process complete
```

---

## Security Notes

- All endpoints require authentication via secret code
- Secret codes are tracked with last used timestamp
- Images are validated for proper format before processing
- All database operations are wrapped in try-catch blocks
- Prisma connections are properly closed after each request

---

## Mobile App Integration

### Required Permissions

- Camera access for race pack photo capture
- Network access for API calls

### Recommended Implementation

1. Store authentication token after successful auth
2. Implement retry logic for network failures
3. Validate base64 image format before sending
4. Handle both success and error responses appropriately
5. Show appropriate UI based on `checkedType` response

---

## Testing

Use the following test data for development:

### Valid Test Cases

- Valid registration ID with paid status
- Proper base64 image format
- Correct boolean values for validation flags

### Error Test Cases

- Invalid registration ID
- Unpaid registration
- Invalid image format
- Missing required fields
- Invalid secret code

---

*Last updated: January 2025*
